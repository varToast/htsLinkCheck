<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Link Scout — HTS Poly Micro-site Checker</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f2f5;
      color: #1a1a1a;
      padding: 0 0 4rem;
    }

    /* ── Top bar ── */
    header {
      background: #1e3a5f;
      color: #fff;
      padding: 1.1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    header h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: .02em; }
    header p  { font-size: 0.82rem; color: #93c5fd; }

    #compare-all-btn {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: .55rem 1.2rem;
      border-radius: 6px;
      font-size: .9rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }
    #compare-all-btn:hover { background: #1d4ed8; }
    #compare-all-btn:disabled { opacity: .55; cursor: default; }

    /* ── Layout ── */
    main { max-width: 1100px; margin: 2rem auto; padding: 0 1.5rem; display: flex; flex-direction: column; gap: 2rem; }

    /* ── Section card ── */
    .section-card {
      background: #fff;
      border-radius: 10px;
      border: 1px solid #dde1e7;
      overflow: hidden;
    }
    .section-header {
      background: #1e3a5f;
      color: #fff;
      padding: .7rem 1.25rem;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .02em;
    }

    /* ── Product table ── */
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      padding: .5rem 1rem;
      font-size: .75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #64748b;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    tbody tr { border-bottom: 1px solid #f1f5f9; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr.result-row { background: #f8fafc; border-top: none; }
    td { padding: .55rem 1rem; vertical-align: middle; font-size: .875rem; }
    td a { color: #2563eb; text-decoration: none; word-break: break-all; }
    td a:hover { text-decoration: underline; }

    /* ── Status badges ── */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 700;
      white-space: nowrap;
    }
    .badge-pending  { background: #f1f5f9; color: #64748b; }
    .badge-ok       { background: #dcfce7; color: #15803d; }
    .badge-mismatch { background: #fee2e2; color: #b91c1c; }
    .badge-no-docs  { background: #fef9c3; color: #92400e; }
    .badge-error    { background: #ffedd5; color: #c2410c; }
    .badge-loading  { background: #e0f2fe; color: #0369a1; }

    /* ── Compare button ── */
    .compare-btn {
      background: none;
      border: 1px solid #2563eb;
      color: #2563eb;
      padding: .3rem .75rem;
      border-radius: 5px;
      font-size: .8rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .compare-btn:hover { background: #eff6ff; }
    .compare-btn:disabled { opacity: .45; cursor: default; }

    /* ── Result detail panel ── */
    .detail-panel {
      padding: .75rem 1rem .9rem 1rem;
      font-size: .83rem;
      display: none;
    }
    .detail-panel.open { display: block; }
    .detail-panel .error-msg { color: #b91c1c; margin-bottom: .4rem; }

    .link-group { margin-top: .6rem; }
    .link-group-label {
      font-weight: 700;
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: .3rem;
    }
    .link-list { list-style: none; display: flex; flex-direction: column; gap: .2rem; }
    .link-list li { display: flex; align-items: baseline; gap: .5rem; }
    .link-list li a { color: #2563eb; word-break: break-all; }
    .link-list li a:hover { text-decoration: underline; }
    .dot-ok      { color: #16a34a; font-size: 1rem; line-height: 1; }
    .dot-missing { color: #dc2626; font-size: 1rem; line-height: 1; }
    .dot-extra   { color: #d97706; font-size: 1rem; line-height: 1; }

    .no-docs-note { color: #92400e; font-style: italic; }

    /* ── Global progress bar ── */
    #progress-bar-wrap {
      display: none;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #dde1e7;
      padding: .75rem 1.25rem;
      font-size: .875rem;
      color: #334155;
    }
    #progress-bar-wrap progress { width: 100%; margin-top: .4rem; accent-color: #2563eb; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Link Scout</h1>
    <p>Comparing HTS Poly live product pages to micro-site QR pages (.pdf / .doc links only)</p>
  </div>
  <button id="compare-all-btn" onclick="compareAll()">Compare All</button>
</header>

<main>
  <div id="progress-bar-wrap">
    <span id="progress-label">Running…</span>
    <progress id="progress-bar" max="1" value="0"></progress>
  </div>

  {% set sections = products.keys() | list %}
  {% for section in sections %}
  <div class="section-card" id="section-{{ loop.index }}">
    <div class="section-header">{{ section }}</div>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Live Page</th>
          <th>Micro Site</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for product in products[section] %}
        {% set slug = product.live.split('/product/')[-1] %}
        {% set rowid = slug | replace('/', '-') %}
        <tr id="row-{{ rowid }}">
          <td><strong>{{ product.name }}</strong></td>
          <td><a href="{{ product.live }}" target="_blank">htspoly.com/product/{{ slug }}</a></td>
          <td><a href="{{ product.micro }}" target="_blank">qr.htspoly.com/{{ slug }}</a></td>
          <td id="status-{{ rowid }}">
            <span class="badge badge-pending">—</span>
          </td>
          <td>
            <button class="compare-btn" id="btn-{{ rowid }}"
              onclick="compareProduct('{{ rowid }}', '{{ product.name }}', '{{ product.live }}', '{{ product.micro }}')">
              Compare
            </button>
          </td>
        </tr>
        <tr class="result-row" id="result-row-{{ rowid }}" style="display:none">
          <td colspan="5">
            <div class="detail-panel open" id="detail-{{ rowid }}"></div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</main>

<script>
  function esc(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  function statusBadge(status) {
    const map = {
      ok:       ['badge-ok',       '✓ Match'],
      mismatch: ['badge-mismatch', '✗ Mismatch'],
      no_docs:  ['badge-no-docs',  '— No docs on live'],
      error:    ['badge-error',    '! Error'],
      loading:  ['badge-loading',  '⟳ Loading…'],
    };
    const [cls, label] = map[status] || ['badge-pending', '—'];
    return `<span class="badge ${cls}">${label}</span>`;
  }

  function renderDetail(result) {
    let html = '';

    if (result.live_error)  html += `<div class="error-msg">Live page error: ${esc(result.live_error)}</div>`;
    if (result.micro_error) html += `<div class="error-msg">Micro site error: ${esc(result.micro_error)}</div>`;

    if (!result.live_links.length && !result.live_error) {
      html += `<p class="no-docs-note">No .pdf / .doc links found on the live product page.</p>`;
    }

    if (result.live_links.length) {
      html += `<div class="link-group">
        <div class="link-group-label">Live page doc links</div>
        <ul class="link-list">`;
      result.live_links.forEach(l => {
        const inMicro  = result.matched.includes(l.href);
        const icon     = inMicro ? '<span class="dot-ok">●</span>' : '<span class="dot-missing">●</span>';
        const tip      = inMicro ? 'Present on micro site' : 'Missing from micro site';
        const filename = l.href.split('/').pop().split('?')[0];
        html += `<li>${icon} <a href="${esc(l.href)}" target="_blank" title="${tip}">${esc(filename)}</a>
                     <span style="color:#94a3b8;font-size:.75rem">${esc(l.text)}</span></li>`;
      });
      html += `</ul></div>`;
    }

    if (result.extra_on_micro.length) {
      html += `<div class="link-group">
        <div class="link-group-label" style="color:#d97706">Extra on micro site (not on live)</div>
        <ul class="link-list">`;
      result.extra_on_micro.forEach(href => {
        const filename = href.split('/').pop().split('?')[0];
        html += `<li><span class="dot-extra">●</span> <a href="${esc(href)}" target="_blank">${esc(filename)}</a></li>`;
      });
      html += `</ul></div>`;
    }

    return html || '<p style="color:#64748b;font-style:italic">No information available.</p>';
  }

  async function compareProduct(rowid, name, live, micro) {
    const statusEl = document.getElementById('status-' + rowid);
    const btn      = document.getElementById('btn-' + rowid);
    const resultRow = document.getElementById('result-row-' + rowid);
    const detail   = document.getElementById('detail-' + rowid);

    statusEl.innerHTML = statusBadge('loading');
    btn.disabled = true;

    try {
      const resp = await fetch('/compare', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, live, micro }),
      });
      const result = await resp.json();

      statusEl.innerHTML = statusBadge(result.status);
      detail.innerHTML   = renderDetail(result);
      resultRow.style.display = '';
    } catch (err) {
      statusEl.innerHTML = statusBadge('error');
      detail.innerHTML   = `<div class="error-msg">Request failed: ${esc(err.message)}</div>`;
      resultRow.style.display = '';
    }

    btn.disabled = false;
    btn.textContent = 'Re-run';
  }

  async function compareAll() {
    const allBtns = document.querySelectorAll('.compare-btn');
    allBtns.forEach(b => b.disabled = true);

    const allBtn = document.getElementById('compare-all-btn');
    allBtn.disabled = true;

    // Collect all products from the rendered rows
    const products = [];
    document.querySelectorAll('tbody tr[id^="row-"]').forEach(row => {
      const rowid = row.id.replace('row-', '');
      const btn   = document.getElementById('btn-' + rowid);
      const tds   = row.querySelectorAll('td');
      const name  = tds[0].textContent.trim();
      const live  = tds[1].querySelector('a').href;
      const micro = tds[2].querySelector('a').href;
      products.push({ rowid, name, live, micro });
    });

    const wrap  = document.getElementById('progress-bar-wrap');
    const bar   = document.getElementById('progress-bar');
    const label = document.getElementById('progress-label');
    wrap.style.display = 'block';
    bar.max   = products.length;
    bar.value = 0;
    label.textContent = `Comparing 0 / ${products.length}…`;

    for (let i = 0; i < products.length; i++) {
      const { rowid, name, live, micro } = products[i];
      label.textContent = `Comparing ${i + 1} / ${products.length} — ${name}`;

      const statusEl  = document.getElementById('status-' + rowid);
      const resultRow = document.getElementById('result-row-' + rowid);
      const detail    = document.getElementById('detail-' + rowid);
      statusEl.innerHTML = statusBadge('loading');

      try {
        const resp   = await fetch('/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, live, micro }),
        });
        const result = await resp.json();
        statusEl.innerHTML      = statusBadge(result.status);
        detail.innerHTML        = renderDetail(result);
        resultRow.style.display = '';
      } catch (err) {
        statusEl.innerHTML      = statusBadge('error');
        detail.innerHTML        = `<div class="error-msg">Request failed: ${esc(err.message)}</div>`;
        resultRow.style.display = '';
      }

      bar.value = i + 1;
    }

    label.textContent = `Done — ${products.length} products compared.`;
    allBtn.disabled = false;
    allBtns.forEach(b => { b.disabled = false; b.textContent = 'Re-run'; });
  }
</script>
</body>
</html>
